{% extends 'layouts/base.html' %}
{% load static %}
{% block content %}
  <style>
    .svgrow {
      max-width: 100vw;
      overflow-x: auto;
      max-height: 500px;
      overflow-y: auto;
    }
    .svgrow svg {
      min-width: 70rem;
    }
    
    .tree-node-label {
      cursor: pointer;
    }
    menu {
      position: absolute;
      display: block;
      left: 0px;
      top: 0px;
      height: 20px;
      width: 20px;
      padding: 0;
      margin: 0;
      border: 1px solid;
      background-color: white;
      font-weight: normal;
      white-space: nowrap;
    }
    menu:hover {
      background-color: #eef;
      font-weight: bold;
    }
    menu:hover > menu {
      display: block;
      cursor: pointer;
    }
    menu > menu {
      display: none;
      position: relative;
      top: -20px;
      left: 100%;
      width: 280px;
    }
    menu[title]:before {
      content: attr(title);
    }
    menu:not([title]):before {
      content: '\2630';
    }
  </style>
  <div class="content">
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <div class="card-header">
              <div class="row">
                <div class="col-sm-6 text-left">
                  <h2 class="card-title">Location Tree View</h2>
                  <select id="selectNode"></select>
                </div>
              </div>
            </div>
            <div class="svgrow" id="tree-div">
              <div id="tree-container"></div>
              <div id="tree-container-locator"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="menustorage">
    <div id="menu-storage-locator"></div>
  </div>
  <div id="cords"></div>
{% endblock %}

{% block extrascripts %}
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script>
    document.onmousemove = handleMouseMove
    document.onclick = function (event) {
      closeMenu()
    }
    document.oncontextmenu = function (event) {
      event.preventDefault()
      return false
    }
    // FIXME: Might want to delete/customize these things
    function addItem() {
      console.log('addItem clicked')
    }
    
    function addBox() {
      console.log('addBox clicked')
    }
    
    function removeBox() {
      console.log('removeBox clicked')
    }
    
    function closeMenu() {
      var men = document.getElementById('rmenu')
      if (men === null) {
      } else {
        men.remove()
      }
    }
    
    function displayContextMenu(id, type, url) {
      closeMenu()
      console.log('displayContextMenu clicked')
      console.log(id, type, url)
    
      var rmenu = document.createElement('menu')
      rmenu.setAttribute('id', 'rmenu')
      rmenu.setAttribute('style', 'display:none;z-index:100;')
    
      if (type == 'Location') {
        let men1 = document.createElement('menu')
        men1.setAttribute('onclick', 'addBoxInLocation()')
        men1.innerText += 'Add box into current location'
        rmenu.append(men1)
        let men2 = document.createElement('menu')
        men2.setAttribute('onclick', 'removeBoxfromLocation()')
        men2.innerText += 'Remove box from current location'
        rmenu.append(men2)
      } else if (type == 'Box') {
        let men1 = document.createElement('menu')
        men1.setAttribute('onclick', 'addItemInBox()')
        men1.innerText += 'Add item portion into box'
        rmenu.append(men1)
        let men2 = document.createElement('menu')
        men2.setAttribute('onclick', 'addBoxInBox()')
        men2.innerText += 'Add box into box'
        rmenu.append(men2)
        let men3 = document.createElement('menu')
        men3.setAttribute('onclick', 'removeBoxfromBox()')
        men3.innerText += 'Remove box from current box'
        rmenu.append(men3)
      } else if (type == 'Portion') {
        let men1 = document.createElement('menu')
        men1.setAttribute('onclick', 'removePortionfromBox()')
        men1.innerText += 'Remove item portion from current box'
        rmenu.append(men1)
      }
    
      locator = document.getElementById('menu-storage-locator')
      const location = document.getElementById('menustorage')
      location.insertBefore(rmenu, locator.nextSibling)
    
      rmenu.style.display = 'block'
      rmenu.style.left = document.getElementById('cords').getAttribute('x') - 10 + 'px'
      rmenu.style.top = document.getElementById('cords').getAttribute('y') - 10 + 'px'
    }
    
    function handleMouseMove(event) {
      let x = event.clientX
      let y = event.clientY
      let cords = document.getElementById('cords')
      cords.setAttribute('x', x)
      cords.setAttribute('y', y)
    }
    
    function renderTree(treeData) {
      light_color = localStorage.getItem('light_color')
      var root = d3.hierarchy(treeData)
      root.sort(function (a, b) {
        return a.data.type.toLowerCase().localeCompare(b.data.type.toLowerCase())
      })
      padding = 3
      var width = 500
    
      const dx = 100
      const dy = width / (root.height + padding)
      height = dy * root.height
    
      var levelWidth = [1]
      var childCount = function (level, n) {
        if (n.children && n.children.length > 0) {
          if (levelWidth.length <= level + 1) levelWidth.push(0)
    
          levelWidth[level + 1] += n.children.length
          n.children.forEach(function (d) {
            childCount(level + 1, d)
          })
        }
      }
      childCount(0, root)
      var newHeight = d3.max(levelWidth) * 50
    
      var svg = d3.select('#tree-container').append('svg').append('g').attr('id', 'tree-svg')
    
      var tree = d3.tree().size([newHeight, width])
      var treeData = tree(root)
    
      var stroke = '#2181ff' // stroke for links
      var strokeWidth = 1.5 // stroke width for links
      var strokeOpacity = 0.4 // stroke opacity for links
    
      const nodes = treeData.descendants()
      nodes.forEach(function (d) {
        d.y = d.depth * 180
      })
    
      const link = svg
        .append('g')
        .attr('fill', 'none')
        .attr('stroke', stroke)
        .attr('stroke-opacity', strokeOpacity)
        .attr('stroke-width', strokeWidth)
        .selectAll()
        .data(root.links())
        .join('path')
        .attr(
          'd',
          d3
            .linkHorizontal()
            .x((d) => d.y)
            .y((d) => d.x)
        )
    
      const node = svg
        .append('g')
        .attr('stroke-linejoin', 'round')
        .attr('stroke-width', 3)
        .selectAll()
        .data(root.descendants())
        .join('g')
        .attr('transform', (d) => `translate(${d.y},${d.x})`)
    
      node
        .append('circle')
        .attr('fill', (d) => (d.children ? '#555' : '#999'))
        .attr('r', 2.5)
    
      node
        .append('a')
        .attr('href', (d) => d.data.url)
        .attr('oncontextmenu', (d) => "displayContextMenu('" + d.data.id.toString() + "','" + d.data.type.toString() + "','" + d.data.url + "')")
        .attr('class', 'tree-node-label')
        .append('text')
        .attr('dy', '0.31em')
        .attr('x', (d) => (d.children ? -6 : 6))
        .attr('text-anchor', (d) => (d.children ? 'end' : 'start'))
        .text((d) => d.data.type + ': ' + d.data.name)
        .clone(true)
        .lower()
        .attr('stroke', light_color == 'true' ? null : stroke)
    
      var treeSvg = document.getElementById('tree-svg')
      console.log()
      var bbox = treeSvg.getBBox()
    
      d3.select('#tree-container')
        .select('svg')
        .attr('width', bbox.width + 200)
        .attr('height', bbox.height + 100)
        .select('g')
        .attr('transform', 'translate(' + 300 + ',' + 0 + ')')
    }
    
    fetch('func/get_tree_data/')
      .then((response) => response.json())
      .then((data) => {
        var selectedIndex = 0
        var selectNode = document.getElementById('selectNode')
        for (var i = 0; i < data.length; i++) {
          var o = document.createElement('option')
          o.value = i
          o.text = 'Location: ' + data[i].name
          selectNode.appendChild(o)
        }
    
        selectNode.onchange = function () {
          selectedIndex = selectNode.selectedIndex
          const element = document.getElementById('tree-container')
          element.remove()
          var newContainer = document.createElement('div')
          newContainer.setAttribute('id', 'tree-container')
          locator = document.getElementById('tree-container-locator')
          const treeDiv = document.getElementById('tree-div')
          treeDiv.insertBefore(newContainer, locator.nextSibling)
    
          renderTree(data[selectedIndex])
        }
    
        renderTree(data[selectedIndex]) // Assuming data[0] is the root node of the tree
      })
  </script>
{% endblock %}
